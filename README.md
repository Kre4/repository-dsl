# Repository DSL –¥–ª—è Kotlin + Spring JDBC

–ù–µ–¥–∞–≤–Ω–æ –ø—Ä–∏–Ω—è–ª —É—á–∞—Å—Ç–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Kotlin + Spring JDBC. –í –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç –º–Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏–ª–æ—Å—å –Ω–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É: –Ω–∞–π–¥–∏ –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ —É—Å–ª–æ–≤–∏—é, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞, —Ç–æ –æ–±–Ω–æ–≤–∏ –ø–æ–ª–µ X, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å.

–î–∞–≤–∞–π—Ç–µ –ø—Ä–∏–≤–µ–¥—É –ø—Ä–∏–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª–µ–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ –∫–æ–¥. –î–æ–ø—É—Å—Ç–∏–º, –≤—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤. –°—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏—è –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –µ–≥–æ. –í —Ç–æ –∂–µ –≤—Ä–µ–º—è, –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∑–≤–æ–ª—è—Ç—å —Å—Ç—É–¥–µ–Ω—Ç—É –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏, –¥–æ–ø—É—Å—Ç–∏–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞, –Ω–æ–º–µ—Ä–∞ –∑–∞–¥–∞—á–∏ –∏ —Å–∞–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π.

## –ü–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥: Kotlin null-safety

–ö–æ—Ç–ª–∏–Ω –¥–æ–≤–æ–ª—å–Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —è–∑—ã–∫, –ø—ã—Ç–∞—é—â–∏–π—Å—è —Å–æ–∑–¥–∞—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –ª–µ–≥–∫–æ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π—Å—è —á–∏—Ç–∞—é—â–∏–º. –û–ø–∏—Å–∞–Ω–Ω–∞—è –≤—ã—à–µ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

```kotlin
taskAnswerRepository.save(
    taskAnswerRepository.findByTaskNumberAndStudentId(dto.taskNumber, dto.studentId)?.also {
        it.savedAnswer = dto.answer
    } ?: TaskAnswer(
        studentId = dto.studentId,
        savedAnswer = dto.answer,
        taskNumber = dto.taskNumber
    )
)
```

## –í—Ç–æ—Ä–æ–π –ø–æ–¥—Ö–æ–¥: Java Optional

–î–∂–∞–≤–æ–≤—Å–∫–∏–π Optional –≤—ã–≥–ª—è–¥–∏—Ç —É–∂–µ –ª—É—á—à–µ:

```kotlin
taskAnswerRepository.save(
    taskAnswerRepository.findByTaskNumberAndStudentIdOptional(dto.taskNumber, dto.studentId)
        .orElse(
            TaskAnswer(
                studentId = dto.studentId,
                savedAnswer = dto.answer,
                taskNumber = dto.taskNumber
            )
        )
)
```

–ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —á—Ç–æ–±—ã –æ—Å–æ–∑–Ω–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫ —Ç–æ–º—É –∂–µ, –∑–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Optional, –∫–æ–≥–¥–∞ Kotlin –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç null safety –∏–∑ –∫–æ—Ä–æ–±–∫–∏?

## –†–µ—à–µ–Ω–∏–µ: DSL –¥–ª—è Repository

–ù–µ–¥–∞–≤–Ω–æ –•–∞–±—Ä –ø–æ–¥—Å—É–Ω—É–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é [—Å—Ç–∞—Ç—å—é](https://habr.com/ru/companies/haulmont/articles/341402/) –ø—Ä–æ Kotlin DSL, –∞–≤—Ç–æ—Ä —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –∫—Ä–∞–π–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª–∏–ª –∫–æ–º–∞–Ω–¥–µ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –±—ã—Å—Ç—Ä–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.

–í –æ–±—â–µ–º —è —Ä–µ—à–∏–ª –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ—à–∞—Ç—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É —Ç–∞–∫:

```kotlin
taskAnswerRepository.saveUpdate {
    bySearch {
        findByTaskNumberAndStudentId(dto.taskNumber, dto.studentId)
    }
    ifExists {
        savedAnswer = dto.answer
    }
    ifNew {
        TaskAnswer(
            studentId = dto.studentId,
            savedAnswer = dto.answer,
            taskNumber = dto.taskNumber
        )
    }
}
```

–ë–æ–ª—å—à–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —É–º–µ–µ—Ç, –∞ —Ç–æ —á—Ç–æ —É–º–µ–µ—Ç –Ω–µ —Ñ–∞–∫—Ç, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ö–æ—Ä–æ—à–æ.

**–°–ø–æ–π–ª–µ—Ä:** —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª Optional –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º ü´†
